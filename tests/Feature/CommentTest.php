<?php

namespace Tests\Feature;

use App\Comment;
use App\DashboardUser;
use App\Task;
use App\User;
use Illuminate\Database\Query\Builder;
use Illuminate\Foundation\Testing\DatabaseMigrations;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Foundation\Testing\WithFaker;
use Tests\TestCase;

class CommentTest extends TestCase
{

    use DatabaseMigrations;

    private $user;


    protected function setUp(): void
    {
        parent::setUp(); // TODO: Change the autogenerated stub

        $this->seed();

        $this->user = User::find(2);
    }


    /**
     * test user can create comment
     *
     * @return void
     */
    public function testUserCanCreateComment()
    {
        $task = Task::whereIn('dashboard_id', function ($query) {
            return $this->getDashboardIDForUser($query);
        })->first();

        $data = ['content' => 'some text'];
        $requried = ['task' => $task->id];

        $response = $this->actingAs($this->user, 'api')
            ->postJson(route('comments.create', $requried), $data);

        $response->assertCreated()
            ->assertSee($data['content']);
    }


    /**
     * test user can create comment
     *
     * @return void
     */
    public function testUserCanNotCreateComment()
    {
        $task = Task::whereNotIn('dashboard_id', function ($query) {
            return $this->getDashboardIDForUser($query);
        })->first();

        $data = ['content' => 'some text'];
        $requried = ['task' => $task->id];

        $response = $this->actingAs($this->user, 'api')
            ->postJson(route('comments.create', $requried), $data);

        $response->assertForbidden();
    }


    /**
     * test user can update comment
     *
     * @return void
     */
    public function testUserCanUpdateComment()
    {
        $comment = Comment::where('owner_id', $this->user->id)->first();

        $data = $comment->toArray();
        $data['content'] = 'anoth text';

        $requried = ['comment' => $comment->id];

        $response = $this->actingAs($this->user, 'api')
            ->putJson(route('comments.update', $requried), $data);

        $response->assertStatus(200)
            ->assertSee($data['content']);
    }


    /**
     * test user can update comment
     *
     * @return void
     */
    public function testUserCanNotUpdateComment()
    {
        $comment = Comment::where('owner_id', '<>', $this->user->id)->first();

        $data = $comment->toArray();
        $data['content'] = 'anoth text';

        $requried = ['comment' => $comment->id];

        $response = $this->actingAs($this->user, 'api')
            ->putJson(route('comments.update', $requried), $data);

        $response->assertForbidden();
    }


    /**
     * test user can update comment
     *
     * @return void
     */
    public function testUserCanDeleteComment()
    {
        $comment = Comment::where('owner_id', $this->user->id)->first();
        $requried = ['comment' => $comment->id];

        $response = $this->actingAs($this->user, 'api')
            ->deleteJson(route('comments.delete', $requried));
        $response->assertStatus(200);

        $comment = Comment::find($comment->id);
        $this->assertEmpty($comment);

    }


    /**
     * test user can update comment
     *
     * @return void
     */
    public function testUserCanNotDeleteComment()
    {
        $comment = Comment::where('owner_id', '<>', $this->user->id)->first();

        $requried = ['comment' => $comment->id];

        $response = $this->actingAs($this->user, 'api')
            ->deleteJson(route('comments.delete', $requried));

        $response->assertForbidden();
    }


    /**
     * @param Builder $query
     *
     * @return Builder
     */
    private function getDashboardIDForUser(Builder $query): Builder
    {
        return $query->select('dashboard_id')
            ->from((new DashboardUser)->getTable())
            ->where('user_id', $this->user->id);
    }
}
